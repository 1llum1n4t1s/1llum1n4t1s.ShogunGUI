# 権限付与・ファイル配置の見直し

ログに「ファイル書き込みの権限が必要」「指定ディレクトリへの配置にはシステム権限が必要」などが出る場合の対応です。

---

## Claude Code CLI のディレクトリアクセス（参考）

- **起動時に追加**: `claude --add-dir <パス>` で、そのディレクトリを「アクセス可能な一覧」に追加する（本アプリは起動時にこのフラグでドキュメントルートを渡している）。
- **セッション中に追加**: すでに CLI を起動している場合はスラッシュコマンド `/add-dir <パス>` で追加できる（相対・絶対どちらも可）。
- **承認プロンプトを省略したい場合（信頼済みディレクトリ）**: ファイルの読み書きのたびに Y/N を聞かれるのを避けたい場合は、対話モードで `/permissions` を実行し、対象の操作やディレクトリに「常に許可（Always allow）」を設定する。  
  本アプリは CLI を**非対話**（`-p` でプロンプト渡し・stdin 閉じ）で動かすため、実行中に Y/N に答えられない。そのため、**事前に** Claude Code を対話で起動し、`/add-dir <ドキュメントルート>` のあと `/permissions` でドキュメントルートを「常に許可」にしておくと、設定が永続化されていればアプリから起動した CLI でも承認なしで書き込める可能性がある。

## アプリからコマンドで指定する（既定で有効）

**Shogun.Avalonia** は、家老・足軽用に Claude Code CLI を起動する際、次を指定しています。

1. **`--add-dir`**  
   ドキュメントルートを「アクセス可能なディレクトリ」に追加する。
2. **`--allowedTools`**  
   ドキュメントルート配下の **Read / Edit / Write** を承認プロンプトなしで許可する（`Read`, `Edit(<ドキュメントルート>/*)`, `Write(<ドキュメントルート>/*)` を渡している）。

これにより、**対話での `/permissions` 設定や手動の「常に許可」は原則不要**です。アプリを再起動すると反映されます。まだ「権限が必要」や scratchpad への保存になる場合は、下記の手動設定を試してください。

---

## 手動設定: Claude Code CLI で「常に許可」を設定（上記で足りない場合）

本アプリは起動時に **`--allowedTools`** でドキュメントルート配下の Read/Edit/Write を許可しています。それでも承認プロンプトが出る場合は、事前に CLI 対話で「常に許可」を設定すると有効な場合があります。

1. **ターミナルで Claude Code を対話起動する**  
   （例: `npx @anthropic-ai/claude-code` またはアプリ内の Node で `node "…\cli.js"`）
2. **ドキュメントルートを追加する**  
   `/add-dir C:\Users\<あなたのユーザー名>\Documents\Shogun`（実際の document_root に合わせる）
3. **権限設定を開く**  
   `/permissions` を実行し、対話モードでドキュメントルート（または該当する操作）に **「常に許可（Always allow）」** を設定する。
4. **終了後、Shogun.Avalonia から再実行**  
   設定が永続化されていれば、アプリが起動する CLI でも承認プロンプトなしで書き込める可能性があります。

---

## 設定でパーミッションをスキップ（Windows で --allowedTools が効かない場合）

Claude Code CLI には **`--dangerously-skip-permissions`** フラグがあり、すべてのパーミッションプロンプトをスキップします。  
Windows では `--allowedTools` のパス指定が正しくマッチしない既知の不具合があり、その場合にこのフラグで回避できます。

- **設定方法**: Shogun.Avalonia の **設定** 画面で「Claude Code CLI のパーミッションをスキップ（dangerously_skip_permissions）」にチェックを入れる。  
  または `config/settings.yaml` に `dangerously_skip_permissions: true` を追加する。
- **反映**: 設定変更後は**アプリを再起動**してください（常駐プロセス起動時にのみ読み込まれます）。
- **注意**: 有効にすると、エージェントがドキュメントルート外のファイルも編集できてしまいます。信頼できる環境でのみ、自己責任で有効にしてください。

---

## 1. なぜ「権限が必要」と出るか

- **Shogun.Avalonia** は Node で agent-runner を起動し、**RUNNER_CWD** にドキュメントルートを、**RUNNER_ADD_DIR** に同じパスを渡し、CLI 起動時に **`--add-dir`** でドキュメントルートを指定しています。
- **Claude Code** はサンドボックス内で動作し、ツール（Edit / Write 等）でファイルを触る際に「許可されたディレクトリ」（CWD および `--add-dir` で指定したパス）が対象になります。加えて、**書き込みのたびに Y/N の承認プロンプト** が出る場合があり、本アプリは非対話で動かすためそのプロンプトに答えられず、結果として scratchpad に保存して「権限確認後にお願い」となることがあります。
- ドキュメントルートがアクセス可能かつ「承認なしで実行」になっていないと、エージェントが `config/settings.yaml` や `queue/` 配下を直接編集できず「権限が必要」や scratchpad への保存になります。本アプリでは **`--add-dir`** に加え **`--allowedTools`** でドキュメントルート配下の Read/Edit/Write を許可しているため、多くの場合は手動設定不要です。
- **報告ファイル**（`queue/reports/ashigaru*_report.yaml`）は、ジョブ完了時に**アプリ側**で `WriteReportFromAshigaruResult` により書き込むため、エージェントに書き込み権限がなくても `queue/reports/` には保存されます。  
  「権限が必要」と出るのは主に、**家老・足軽が config/ や queue/ のファイルを自分で編集しようとする**ときです。

---

## 2. その他の案（上記で足りない場合）

### 2.1 ドキュメントルートを %LOCALAPPDATA% 配下に変更する

- **document_root** を、例えば `%LOCALAPPDATA%\Shogun`（`C:\Users\<user>\AppData\Local\Shogun`）に変更します。
- 同じユーザーで動くアプリ・CLI からは通常このパスは書き込みしやすく、サンドボックスが「ユーザーのアプリデータ」を許可している場合、エージェントの書き込みが通る可能性があります。
- **手順**:
  1. `%LOCALAPPDATA%\Shogun` を作成。
  2. 既存の `Documents\Shogun` から `config/`・`queue/`・`instructions/` 等をコピー（または移動）。
  3. Shogun.Avalonia の設定で **document_root** を `%LOCALAPPDATA%\Shogun` に変更。  
     （設定画面の「ドキュメントルート」でそのフォルダを指定するか、既存の `config/settings.yaml` の `document_root` を書き換え。）
  4. 必要に応じて Claude Code CLI の対話で `/add-dir` と `/permissions` により「常に許可」を設定する。

**メリット**: Documents と分離でき、バックアップ・同期の対象から外しやすい。  
**デメリット**: 既存の「Documents\Shogun」前提の手順やスクリプトがあれば、パスを合わせる必要がある。

---

## 3. 運用のポイント

| 項目 | 説明 |
|------|------|
| **報告ファイル** | `queue/reports/ashigaru*_report.yaml` はジョブ完了時に**アプリ**が書き込むため、エージェントに書き込み権限がなくても保存されます。 |
| **config / queue の編集** | 本アプリは CLI 起動時に **`--add-dir`** と **`--allowedTools`** を指定しています。まだ承認プロンプトが出る場合は、手動で **`/permissions`** を設定するか、設定の **dangerously_skip_permissions** を有効にしてください（上記「設定でパーミッションをスキップ」参照）。 |
| **keybindings.json 等** | 「keybindings.json が見つからない」は、エージェントが参照しているエディタの設定パスが環境と一致していない場合によく出ます。Shogun のドキュメントルートの権限とは別問題なので、必要ならタスク内容で「編集対象にしない」ようにします。 |

まずは**アプリの `--add-dir` 指定**で解消するか確認し、それでも解消しない場合に**手動設定**（CLI の `/permissions` で「常に許可」）や、上記 2.1（LocalAppData へ移す）を検討してください。
